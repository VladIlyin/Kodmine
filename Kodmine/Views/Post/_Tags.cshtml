@using Kodmine.Model.Models;

<style>
	option:disabled {
		background-color: rgba(183, 183, 183, 0.2)
	}

    .egg-tag {
        display: inline-block;
        padding: 5px 10px 5px 10px;
        border: solid;
        border-color: #dddddd;
        border-width: thin;
        border-radius: 20px 20px;
        font-size: larger;
        vertical-align: middle;
    }

    .egg-tag a {
        margin: 0;
        padding: 0;
        cursor: pointer;
        opacity: .5;
    }

    .egg-tag a img {
        vertical-align: baseline;
        max-width: 20px;
        height: 15px;
    }

    .egg-tag a:hover {
        opacity: 0.75;
    }
</style>

<script>

    $(function () {

    })

    function onSelectTag() {
	    var selectTagList = $('#select-tag-list')
		var tagName = selectTagList.val()
		var tagId = selectTagList.find('option:selected').attr('id')

		addElementTagToDOM(tagId, tagName)
		addTag(tagId)

        markOption(tagName, true)
    }

    function onClickRemoveTag(e) {
        var tagId = $(e).siblings("span.egg-tag-id").text()
        deleteTag(tagId)

        markOption($(e).siblings("span.egg-tag-title").text(), false)

        $(e).closest("div.egg-tag").remove()
    }

    function addElementTagToDOM(tagId, tagName) {
        var container = $('<div/>').html($('#tagTemp').html())
        container.find('span.egg-tag-title').text(tagName)
        container.find('span.egg-tag-id').text(tagId)
        $('.post-tag-list').append(container.html())
    }

    function addTag(tagId) {

		var data = { tagId: tagId, postId: @Model.PostId };

		$.post("@Url.Action("AddTag")", data, function (data, status, jqXHR) {

        }).fail(function (jqXHR, status, errorThrown) {

        })

    }

    function deleteTag(tagId) {
		var data = { tagId: tagId, postId: @Model.PostId };

		$.post("@Url.Action("RemoveTag")", data, function (data, status, jqXHR) {

        }).fail(function (jqXHR, status, errorThrown) {

        })
    }

    function markOption(name, selected) {
		if(selected)
			$('#select-tag-list option[value="' + name + '"]').attr('disabled', true)
		else
		{
			var elem = $('#select-tag-list')
			elem.find('option[value="' + name + '"]').attr('disabled', false)
			elem.val('')
		}

    }

</script>

<div class="col-md-3">
    <div class="form-group">
        <label class="control-label">Теги</label>
        <select id="select-tag-list" class="form-control" onchange="onSelectTag();">
            <option id="0" hidden disabled selected> -- Выберите тег -- </option>
            @{
                IEnumerable<int> tagIdList = ViewBag.TagIdListOnThisPost;

                foreach (Tag tag in ViewBag.TagList ?? new List<Tag>())
                {
                    if (tagIdList.Contains(tag.TagId))
                    {
                        <option id="@tag.TagId" value="@tag.Name" disabled>@tag.Name</option>
                    }
                    else
                    {
                        <option id="@tag.TagId" value="@tag.Name">@tag.Name</option>
                    }
                }
            }
        </select>
        
    </div>
</div>
<div class="col-md-9 align-bottom tagList">
    @*<div class="form-group">*@
        <label class="control-label">&nbsp;</label>
        <div class="post-tag-list">
		@*</div>*@
    </div>
</div>

<template id="tagTemp">
	<div class="egg-tag">
		<span class="egg-tag-title"></span><span class="egg-tag-id" hidden></span>
			<a onclick="onClickRemoveTag(this);">
				<img src="~/images/si-glyph-button-error.svg" />
			</a>
	</div>
</template>